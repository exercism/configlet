name: Build

on:
  push:
    branches: [master]
    # paths: ["**.nim"]
  pull_request:
    branches: [master]
    # paths: ["**.nim"]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        target:
          - os: linux
            triple: x86_64-linux-musl
          # - os: linux
          #   triple: i686-linux-musl
          # - os: linux
          #   triple: aarch64-linux-musl
          # - os: linux
          #   triple: armv7l-linux-musleabihf
          - os: macosx
            triple: x86_64-apple-darwin14
          - os: windows
            triple: x86_64-w64-mingw32
          # - os: windows
          #   triple: i686-w64-mingw32
        include:
          - target:
              os: linux
            builder: ubuntu-18.04
          - target:
              os: macosx
            builder: macos-10.15
          - target:
              os: windows
            builder: windows-2019

    name: "Build ${{ matrix.target.triple }}"
    runs-on: ${{ matrix.builder }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v1
        with:
          nim-version: "1.2.6"

      - name: Install Nim build tools
        run: ./.github/bin/install-build-tools
        env:
          os: ${{ matrix.target.os }}

      - name: Build binary
        run: ./.github/bin/build
        env:
          os: ${{ matrix.target.os }}
          triple: ${{ matrix.target.triple }}
