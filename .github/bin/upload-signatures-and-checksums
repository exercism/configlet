#!/usr/bin/env sh

set -e

build_tag="${GITHUB_REF_NAME}"

# Download every release asset
download_dir="releases/${build_tag}"
gh release download "${build_tag}" --dir "${download_dir}"

# Write secret key to expected location
if [ -n "${CONFIGLET_MINISIGN_SECRET_KEY}" ]; then
  minisign_dir="${HOME}/.minisign"
  mkdir -p "${minisign_dir}"
  printenv CONFIGLET_MINISIGN_SECRET_KEY > "${minisign_dir}/minisign.key"
else
  printf "CONFIGLET_MINISIGN_SECRET_KEY environment variable not found. Exiting."
  exit 1
fi

cd "${download_dir}" || exit

# Write checksums file
checksums_file="configlet_${build_tag}_checksums_sha256.txt"
sha256sum -- * > "${checksums_file}"

for file in ./*; do
  # Create minisig file with a custom trusted comment
  dt="$(date -u '+%Y-%m-%dT%H:%M:%SZ')" # Like `date --utc --iso=seconds`
  # The below is the same format as minisign's default, but using a non-unix timestamp.
  trusted_comment="timestamp:${dt}   file:${file}    hashed"
  minisign -Sm "${file}" -t "${trusted_comment}"

  # Verify the signed file
  minisign_public_key='RWR9FAzgZvE/ZfMzAmaWmeQNtlYVGMvdHy99HG5jZkZ8WNYGl+whrQvE'
  minisign -Vm "${file}" -P "${minisign_public_key}"
done

# Upload checksums file and signature files
gh release upload "${build_tag}" "${checksums_file}" ./*.minisig
