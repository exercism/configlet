#!/usr/bin/env bash

set -eo pipefail

err() {
  echo "$*" >&2
}

main() {
  if [[ "$#" -eq 1 ]]; then
    local tmp_dir='upload-assets-tmp'
    local repo='github.com/exercism/configlet'
    local tag="$1"
    local arch='x86-64'
    local pattern="*${arch}*"
    mkdir -v -p "${tmp_dir}"
    cd "${tmp_dir}"
    gh -R "${repo}" release download "${tag}" -p "${pattern}"
    declare -A assets=(
      ["configlet_${tag}_linux_${arch}.tar.gz"]='configlet-linux-64bit.tgz'
      ["configlet_${tag}_macos_${arch}.tar.gz"]='configlet-mac-64bit.tgz'
      ["configlet_${tag}_windows_${arch}.zip"]='configlet-windows-64bit.zip'
    )
    for k in "${!assets[@]}"; do
      mv -v "${k}" "${assets[${k}]}"
    done
    gh -R "${repo}" release upload "${tag}" "${assets[@]}"
    echo "After undrafting the new release, you can delete the assets with the old names"
    echo "from the previous release"
  else
    err "You must call this script with exactly one argument."
    err "Usage:"
    err "  upload-legacy-assets <tag>"
    exit 1
  fi
}

main "$@"
