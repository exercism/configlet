#!/usr/bin/env bash

set -eo pipefail

err() {
  echo "$*" >&2
}

main() {
  if [[ "$#" -eq 1 ]]; then
    local tmp_dir='upload-assets-tmp'
    local repo='github.com/exercism/configlet'
    local tag="$1"
    local arch='x86-64'
    local pattern="*${arch}*"
    local oses=('linux' 'macos' 'windows')
    mkdir -v -p "${tmp_dir}"
    cd "${tmp_dir}"
    gh -R "${repo}" release download "${tag}" -p "${pattern}"
    for os in "${oses[@]}"; do
      case "${os}" in
        linux)
          local ext_old='tar.gz'
          local ext_new='tgz'
          local os_old="${os}"
          ;;
        macos)
          local ext_old='tar.gz'
          local ext_new='tgz'
          local os_old='mac'
          ;;
        windows)
          local ext_new='zip'
          local ext_old='zip'
          local os_old="${os}"
          ;;
      esac
      mv -v "configlet_${tag}_${os}_${arch}.${ext_new}" "configlet-${os_old}-64bit.${ext_old}"
    done
    gh -R "${repo}" release upload "${tag}" configlet-*-64bit*
    echo "After undrafting the new release, you can delete the assets with the old names"
    echo "from the previous release"
  else
    err "You must call this script with exactly one argument."
    err "Usage:"
    err "  upload-legacy-assets <tag>"
    exit 1
  fi
}

main "$@"
